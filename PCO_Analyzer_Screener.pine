//@version=5
indicator("PCO Analyzer Screener", "PCO Analyzer", overlay=true, max_boxes_count=500, max_lines_count=500)

// ═══════════════════════════════════════════════════════════════════════════════════════
// PCO ANALYZER SCREENER - COMPREHENSIVE TRADING INDICATOR
// ═══════════════════════════════════════════════════════════════════════════════════════

// Input Settings
group_ma = "Moving Averages"
ma_length = input.int(20, "MA Length", minval=1, group=group_ma)
ma_type = input.string("EMA", "MA Type", options=["SMA", "EMA", "WMA", "RMA"], group=group_ma)

group_rsi = "RSI Settings"
rsi_length = input.int(14, "RSI Length", minval=1, group=group_rsi)
rsi_overbought = input.int(70, "RSI Overbought", minval=50, maxval=100, group=group_rsi)
rsi_oversold = input.int(30, "RSI Oversold", minval=0, maxval=50, group=group_rsi)

group_macd = "MACD Settings"
macd_fast = input.int(12, "MACD Fast Length", minval=1, group=group_macd)
macd_slow = input.int(26, "MACD Slow Length", minval=1, group=group_macd)
macd_signal = input.int(9, "MACD Signal Length", minval=1, group=group_macd)

group_bb = "Bollinger Bands"
bb_length = input.int(20, "BB Length", minval=1, group=group_bb)
bb_mult = input.float(2.0, "BB Multiplier", minval=0.1, group=group_bb)

group_volume = "Volume Analysis"
volume_ma_length = input.int(20, "Volume MA Length", minval=1, group=group_volume)
volume_threshold = input.float(1.5, "Volume Threshold", minval=0.1, group=group_volume)

group_pivots = "Pivot Points"
pivot_length = input.int(10, "Pivot Length", minval=1, group=group_pivots)

group_display = "Display Settings"
show_signals = input.bool(true, "Show Buy/Sell Signals", group=group_display)
show_levels = input.bool(true, "Show Support/Resistance", group=group_display)
show_table = input.bool(true, "Show Analysis Table", group=group_display)

// ═══════════════════════════════════════════════════════════════════════════════════════
// CALCULATIONS
// ═══════════════════════════════════════════════════════════════════════════════════════

// Moving Average Function
ma_function(src, length, ma_type) =>
    switch ma_type
        "SMA" => ta.sma(src, length)
        "EMA" => ta.ema(src, length)
        "WMA" => ta.wma(src, length)
        "RMA" => ta.rma(src, length)

// Main Moving Average
ma = ma_function(close, ma_length, ma_type)

// RSI
rsi = ta.rsi(close, rsi_length)

// MACD
[macd_line, signal_line, histogram] = ta.macd(close, macd_fast, macd_slow, macd_signal)

// Bollinger Bands
bb_basis = ta.sma(close, bb_length)
bb_dev = bb_mult * ta.stdev(close, bb_length)
bb_upper = bb_basis + bb_dev
bb_lower = bb_basis - bb_dev

// Volume Analysis
volume_ma = ta.sma(volume, volume_ma_length)
high_volume = volume > volume_ma * volume_threshold

// Price Action
price_above_ma = close > ma
uptrend = ta.rising(ma, 3)
downtrend = ta.falling(ma, 3)

// Support and Resistance Levels
pivot_high = ta.pivothigh(high, pivot_length, pivot_length)
pivot_low = ta.pivotlow(low, pivot_length, pivot_length)

// ═══════════════════════════════════════════════════════════════════════════════════════
// SIGNAL GENERATION
// ═══════════════════════════════════════════════════════════════════════════════════════

// Bullish Conditions
bullish_ma = close > ma and uptrend
bullish_rsi = rsi < rsi_oversold and rsi[1] >= rsi[0]
bullish_macd = macd_line > signal_line and macd_line[1] <= signal_line[1]
bullish_bb = close <= bb_lower and close[1] > bb_lower[1]

// Bearish Conditions
bearish_ma = close < ma and downtrend
bearish_rsi = rsi > rsi_overbought and rsi[1] <= rsi[0]
bearish_macd = macd_line < signal_line and macd_line[1] >= signal_line[1]
bearish_bb = close >= bb_upper and close[1] < bb_upper[1]

// Strong Buy/Sell Signals
strong_buy = bullish_ma and bullish_rsi and high_volume
strong_sell = bearish_ma and bearish_rsi and high_volume

// Moderate Buy/Sell Signals
moderate_buy = (bullish_ma and bullish_macd) or (bullish_rsi and bullish_bb)
moderate_sell = (bearish_ma and bearish_macd) or (bearish_rsi and bearish_bb)

// ═══════════════════════════════════════════════════════════════════════════════════════
// PLOTTING
// ═══════════════════════════════════════════════════════════════════════════════════════

// Moving Average
plot(ma, "Moving Average", color=color.blue, linewidth=2)

// Bollinger Bands
p1 = plot(bb_upper, "BB Upper", color=color.gray, linewidth=1)
p2 = plot(bb_lower, "BB Lower", color=color.gray, linewidth=1)
fill(p1, p2, color=color.new(color.blue, 95), title="BB Background")

// Support and Resistance Lines
if show_levels
    if not na(pivot_high)
        line.new(bar_index - pivot_length, pivot_high, bar_index, pivot_high,
                 color=color.red, style=line.style_dashed, width=1, extend=extend.right)
    if not na(pivot_low)
        line.new(bar_index - pivot_length, pivot_low, bar_index, pivot_low,
                 color=color.green, style=line.style_dashed, width=1, extend=extend.right)

// Buy/Sell Signals
if show_signals
    if strong_buy
        label.new(bar_index, low - (high - low) * 0.1, "STRONG BUY",
                  color=color.green, style=label.style_label_up, size=size.small, textcolor=color.white)
    else if moderate_buy
        label.new(bar_index, low - (high - low) * 0.05, "BUY",
                  color=color.lime, style=label.style_label_up, size=size.tiny, textcolor=color.white)

    if strong_sell
        label.new(bar_index, high + (high - low) * 0.1, "STRONG SELL",
                  color=color.red, style=label.style_label_down, size=size.small, textcolor=color.white)
    else if moderate_sell
        label.new(bar_index, high + (high - low) * 0.05, "SELL",
                  color=color.orange, style=label.style_label_down, size=size.tiny, textcolor=color.white)

// ═══════════════════════════════════════════════════════════════════════════════════════
// ANALYSIS TABLE
// ═══════════════════════════════════════════════════════════════════════════════════════

if show_table and barstate.islast
    var table info_table = table.new(position.top_right, 2, 8, bgcolor=color.white, border_width=1)

    // Market Trend Analysis
    trend_text = uptrend ? "UPTREND" : downtrend ? "DOWNTREND" : "SIDEWAYS"
    trend_color = uptrend ? color.green : downtrend ? color.red : color.gray

    // RSI Analysis
    rsi_text = rsi > rsi_overbought ? "OVERBOUGHT" : rsi < rsi_oversold ? "OVERSOLD" : "NEUTRAL"
    rsi_color = rsi > rsi_overbought ? color.red : rsi < rsi_oversold ? color.green : color.gray

    // MACD Analysis
    macd_text = macd_line > signal_line ? "BULLISH" : "BEARISH"
    macd_color = macd_line > signal_line ? color.green : color.red

    // Volume Analysis
    volume_text = high_volume ? "HIGH" : "NORMAL"
    volume_color = high_volume ? color.orange : color.gray

    // Price vs MA Analysis
    ma_text = price_above_ma ? "ABOVE MA" : "BELOW MA"
    ma_color = price_above_ma ? color.green : color.red

    // BB Position
    bb_position = close > bb_upper ? "ABOVE BB" : close < bb_lower ? "BELOW BB" : "WITHIN BB"
    bb_color = close > bb_upper ? color.red : close < bb_lower ? color.green : color.gray

    // Overall Signal
    overall_signal = strong_buy ? "STRONG BUY" : moderate_buy ? "BUY" : strong_sell ? "STRONG SELL" : moderate_sell ? "SELL" : "HOLD"
    overall_color = strong_buy ? color.green : moderate_buy ? color.lime : strong_sell ? color.red : moderate_sell ? color.orange : color.gray

    // Populate Table
    table.cell(info_table, 0, 0, "PCO ANALYZER", text_color=color.black, text_size=size.normal, bgcolor=color.yellow)
    table.cell(info_table, 1, 0, "STATUS", text_color=color.black, text_size=size.normal, bgcolor=color.yellow)

    table.cell(info_table, 0, 1, "Trend", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 1, trend_text, text_color=trend_color, text_size=size.small)

    table.cell(info_table, 0, 2, "RSI", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 2, rsi_text, text_color=rsi_color, text_size=size.small)

    table.cell(info_table, 0, 3, "MACD", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 3, macd_text, text_color=macd_color, text_size=size.small)

    table.cell(info_table, 0, 4, "Volume", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 4, volume_text, text_color=volume_color, text_size=size.small)

    table.cell(info_table, 0, 5, "Price vs MA", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 5, ma_text, text_color=ma_color, text_size=size.small)

    table.cell(info_table, 0, 6, "BB Position", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 6, bb_position, text_color=bb_color, text_size=size.small)

    table.cell(info_table, 0, 7, "SIGNAL", text_color=color.black, text_size=size.normal, bgcolor=color.yellow)
    table.cell(info_table, 1, 7, overall_signal, text_color=overall_color, text_size=size.normal, bgcolor=color.yellow)

// ═══════════════════════════════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════════════════════════════

alertcondition(strong_buy, title="Strong Buy Signal", message="PCO Analyzer: Strong Buy Signal Detected")
alertcondition(strong_sell, title="Strong Sell Signal", message="PCO Analyzer: Strong Sell Signal Detected")
alertcondition(moderate_buy, title="Buy Signal", message="PCO Analyzer: Buy Signal Detected")
alertcondition(moderate_sell, title="Sell Signal", message="PCO Analyzer: Sell Signal Detected")